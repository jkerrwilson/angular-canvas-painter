"use strict";!function(t){angular.module("pw.canvas-painter",[]),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(t){try{t=angular.module("pw.canvas-painter")}catch(e){t=angular.module("pw.canvas-painter",[])}t.run(["$templateCache",function(t){t.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(e,n){var o=!!("ontouchstart"in t),a=o?"touchstart":"mousedown",i=o?"touchmove":"mousemove",r=o?"touchend":"mouseup",c=e.options;if(c.canvasId=c.customCanvasId||"pwCanvasMain",c.tmpCanvasId=c.customCanvasId?c.canvasId+"Tmp":"pwCanvasTmp",c.width=c.width||12,c.height=300*c.width/12,c.color=c.color||"#000",c.undoEnabled=c.undoEnabled||!1,c.opacity=c.opacity||.9,c.lineWidth=c.lineWidth||1,c.undo=c.undo||!1,c.backgroundColor=c.backgroundColor||"#000",c.imageSrc=c.imageSrc||"",c.imageSrc){var l=new Image;l.onload=function(){h.drawImage(this,0,0)},l.src=c.imageSrc}if(c.undo){var s=[];e.$watch(function(){return s.length},function(t){e.version=t}),e.$watch("version",function(t){return 0>t?(e.version=0,void 0):t>=s.length?(e.version=s.length,void 0):(b(t),void 0)})}var d=document.createElement("canvas");d.id=c.canvasId;var u=document.createElement("canvas");u.id=c.tmpCanvasId,angular.element(u).css({position:"absolute",top:0,left:0}),n.find("div").append(d),n.find("div").append(u);var h=d.getContext("2d"),p=u.getContext("2d"),v={x:0,y:0},f=[];d.width=u.width=650*c.width/12,d.height=u.height=c.height=300*c.width/12,h.strokeStyle=c.backgroundColor,h.rect(0,0,d.width,d.height),h.stroke(),p.globalAlpha=c.opacity,p.lineJoin=p.lineCap="round",p.lineWidth=10,p.strokeStyle=c.color,e.$watch("options.lineWidth",function(t){"string"==typeof t&&(t=parseInt(t,10)),t&&"number"==typeof t&&(p.lineWidth=c.lineWidth=t)}),e.$watch("options.color",function(t){t&&(p.strokeStyle=p.fillStyle=t)}),e.$watch("options.opacity",function(t){t&&(p.globalAlpha=t)}),e.$watch("options.width",function(t){var e=t||12;d.width=u.width=c.width=650*e/12,d.height=u.height=c.height=300*e/12,h.rect(0,0,d.width,d.height),h.stroke()}),e.$watch("options.imageSrc",function(t){if(t){var e=new Image;e.onload=function(){console.log(e.height,e.width),h.drawImage(e,0,0)},e.src=t}});var g=function(t){var e=0,n=0;do isNaN(t.offsetLeft)||(e+=t.offsetTop,n+=t.offsetLeft),t=t.offsetParent;while(t);return{left:n,top:e}},m=function(t,e){o?(t.x=e.changedTouches[0].pageX-g(e.target).left,t.y=e.changedTouches[0].pageY-g(e.target).top):(t.x=void 0!==e.offsetX?e.offsetX:e.layerX,t.y=void 0!==e.offsetY?e.offsetY:e.layerY)},w=function(t){if(t&&(t.preventDefault(),m(v,t)),f.push({x:v.x,y:v.y}),3===f.length){var e=f[0];return p.beginPath(),p.arc(e.x,e.y,p.lineWidth/2,0,2*Math.PI,!0),p.fill(),p.closePath(),void 0}p.clearRect(0,0,u.width,u.height),p.beginPath(),p.moveTo(f[0].x,f[0].y);for(var n=1;n<f.length-2;n++){var o=(f[n].x+f[n+1].x)/2,a=(f[n].y+f[n+1].y)/2;p.quadraticCurveTo(f[n].x,f[n].y,o,a)}p.quadraticCurveTo(f[n].x,f[n].y,f[n+1].x,f[n+1].y),p.stroke()},y=function(){c.undo&&e.$apply(function(){s.push(h.getImageData(0,0,u.width,u.height)),angular.isNumber(c.undo)&&c.undo>0&&(s=s.slice(-1*c.undo))}),u.removeEventListener(i,w,!1),h.drawImage(u,0,0),p.clearRect(0,0,u.width,u.height),f=[]},C=function(t){t.preventDefault(),u.addEventListener(i,w,!1),m(v,t),f.push({x:v.x,y:v.y}),f.push({x:v.x,y:v.y}),w()},x=function(){function t(){s=!0}function n(){s=!1}function i(){document.body.removeEventListener("mousedown",t),document.body.removeEventListener("mouseup",n)}function c(t){s&&C(t)}function l(t){s&&y(t)}if(u.addEventListener(a,C,!1),u.addEventListener(r,y,!1),!o){var s;document.body.addEventListener("mousedown",t),document.body.addEventListener("mouseup",n),e.$on("$destroy",i),u.addEventListener("mouseenter",c),u.addEventListener("mouseleave",l)}},b=function(t){s.length>0&&(h.putImageData(s[t],0,0),s=s.slice(0,t))};x()}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(t){t.setColor=function(e){t.selectedColor=e}}}})}(this);